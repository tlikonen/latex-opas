% Tekijä:   Teemu Likonen <tlikonen@iki.fi>
% Lisenssi: Creative Commons Nimeä-JaaSamoin 4.0 Kansainvälinen (CC BY-SA 4.0)
% https://creativecommons.org/licenses/by-sa/4.0/legalcode.fi

\documentclass{book}
\usepackage{geometry}
\usepackage[quiet]{fontspec}
\usepackage{polyglossia}
\usepackage[finnish,showseconds=false]{datetime2}
\usepackage{ragged2e}
\usepackage[hang,bottom,norule]{footmisc}
\usepackage[clearempty]{titlesec}
\usepackage{titletoc}
%\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{floatrow}
\usepackage{caption}
\usepackage{newfloat}
\usepackage{fancyvrb}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{noindentafter}
\usepackage[normalem]{ulem}
\usepackage{imakeidx}
% \usepackage{ifthen}
\usepackage{chngcntr}
\usepackage{realscripts}
\usepackage{csquotes}
\usepackage[style=authoryear, dashed=false, maxbibnames=99]{biblatex}
\usepackage{tikz}
\usepackage{totcount}
\usepackage{nowidow} \setnowidow \setnoclub
%\usepackage{showhyphens}
\usepackage{hanging}
\usepackage{lettrine}
\usepackage[unicode,hyperfootnotes=false]{hyperref}
\usepackage[shortcuts]{extdash}

\geometry{ a5paper, twoside, hscale=.72, vscale=.77, hmarginratio=17:28,
  vmarginratio=20:32, footskip=12mm, footnotesep=13bp,
  marginparwidth=50bp, marginparsep=10bp }

% \geometry{ papersize={158mm, 220mm}, layout=a5paper, layoutoffset={5mm,
%     5mm}, showcrop }

\input{versio}

\hypersetup{ hidelinks, bookmarksopen, bookmarksnumbered,
  pdfinfo={
    Title={Käytännöllistä Latexia},
    Subject={Latex-ladontajärjestelmän opas, versio \versio},
    Author={Teemu Likonen <tlikonen@iki.fi>}
  }
}

\setdefaultlanguage{finnish}
\setotherlanguage{english}
\newcommand{\englishfont}{}
\newcommand{\englanti}[1]{\textenglish{#1}}

\defaultfontfeatures{Ligatures={TeX, Required, Common}, Numbers=Lowercase}

% Perusfontin on oltava antiikva, ja tekstissä siitä käytetään seuraavia
% asetuksia: Numbers={Lowercase}, Numbers={Uppercase, SlashedZero},
% Fractions, pienversaalit, aitoja ylä- ja alaindeksejä.
\setmainfont {libertinusserif}
[UprightFont=*-regular,
ItalicFont=*-italic,
SlantedFont=*-regular, SlantedFeatures={FakeSlant=.2},
BoldFont=*-semibold,
BoldItalicFont=*-semibolditalic,
BoldSlantedFont=*-semibold, BoldSlantedFeatures={FakeSlant=.2},
Extension=.otf]

% Fonttiluvussa viitataan tähän perheeseen siten, että se on antiikvan
% ja groteskin välimuoto (päätteetön kaksivahva).
\setsansfont {libertinussans}
[Scale=MatchLowercase,
UprightFont=*-regular,
ItalicFont=*-italic,
SlantedFont=*-regular, SlantedFeatures={FakeSlant=.2},
BoldFont=*-bold,
BoldItalicFont=*-bolditalic,
Extension=.otf]

% Fonttien asetuksia käsittelevässä luvussa viitataan tähän fonttiin ja
% välistyksen tiivistämiseen (FakeStretch).
\setmonofont {libertinusmono}
[Scale=MatchLowercase, Ligatures={TeXReset, NoCommon}, FakeStretch=.8,
Numbers={Uppercase, SlashedZero}, HyphenChar=-,
UprightFont=*-regular,
ItalicFont=*-italic,
BoldFont=*-bold,
BoldItalicFont=*-bolditalic,
Extension=.otf]

% Esimerkkien tulosteet tällä fontilla:
\newcommand{\erikoisfontti}{\rmfamily}

\newfontface{\viivastofontti}{libertinusserif-regular.otf}

\renewcommand{\scriptsize}{\fontsize{7bp}{7bp}\selectfont}
\renewcommand{\footnotesize}{\fontsize{8bp}{9bp}\selectfont}
\renewcommand{\small}{\fontsize{9bp}{10bp}\selectfont}
\renewcommand{\normalsize}{\fontsize{10.5bp}{13bp}\selectfont}
\renewcommand{\large}{\fontsize{13bp}{15bp}\selectfont}
\renewcommand{\Large}{\fontsize{16bp}{18bp}\selectfont}
\renewcommand{\LARGE}{\fontsize{20bp}{22bp}\selectfont}
\renewcommand{\huge}{\fontsize{24bp}{26bp}\selectfont}
\linespread{1}
\normalsize

\newcommand{\gemenanum}{\addfontfeatures{Numbers=Lowercase}}
\newcommand{\versaalinum}{\addfontfeatures{Numbers=Uppercase}}
\newcommand{\murtoluku}[2]{{\addfontfeatures{Fractions=On}#1/#2}}

\urlstyle{sf}
\newcommand{\kulmaurl}[1]
{\href{#1}{\guilsinglleft\nolinkurl{#1}\guilsinglright}}
\newcommand{\kulmasp}[1]
{\href{mailto:#1}{\guilsinglleft\nolinkurl{#1}\guilsinglright}}

\setlength{\emergencystretch}{1em}

\setlength{\parindent}{1em}
\setlength{\bibhang}{\parindent}
\setlength{\bibitemsep}{.5ex plus .1ex minus .1ex}
\newlength{\sisennys}\setlength{\sisennys}{1.8em}
\setlength{\parskip}{0em}
\setlength{\footnotemargin}{.8em}
\setlength{\floatsep}{.8em plus .3em minus .1em}
\setlength{\textfloatsep}{1.3em plus .3em minus .1em}

\addbibresource{kirjallisuutta.bib}
\nocite{*}
\renewcommand{\bibfont}{\RaggedRight}

\DeclareDelimFormat[bib]{nametitledelim}{\addcolon\space}
\DeclareDelimFormat[bib]{multinamedelim}{\space--\space}
\DeclareDelimFormat[bib]{finalnamedelim}{\space--\space}
\DeclareDelimFormat[textcite,parencite]{finalnamedelim}{\space\&\space}
\DeclareFieldFormat{url}{Saatavissa: \kulmaurl{#1}}
\DeclareNameAlias{sortname}{family-given}
\DeclareNameAlias{default}{family-given}
\DefineBibliographyStrings{finnish}{andothers = {ym.}}

\DeclareFloatingEnvironment[ name={Esimerkki} ]{esimerkki}

\indexsetup{level=\section*, toclevel=section, noclearpage}

\makeindex[name=paketit, title={Paketit}, columns=2, columnsep=1em]
\makeindex[name=komennot, title={Komennot}, columns=2, columnsep=1em]
\makeindex[name=ymparistot, title={Ympäristöt}, columns=2, columnsep=1em]
\makeindex[name=mitat, title={Mitat}, columns=2, columnsep=1em]
\makeindex[name=laskurit, title={Laskurit}, columns=1, columnsep=1em]
\makeindex[name=luokat, title={Dokumenttiluokat}, columns=1, columnsep=1em]

\renewcommand{\theFancyVerbLine}
{\sffamily\versaalinum\fontsize{6bp}{7bp}\selectfont\arabic{FancyVerbLine}}

\DefineVerbatimEnvironment{koodilohko}{Verbatim}{ fontsize=\small,
  gobble=0, frame=single, framesep=.4em, numbers=left, numbersep=.3em,
  xleftmargin=0em, xrightmargin=0mm, baselinestretch=1 }

\DefineVerbatimEnvironment{koodilohkosis}{Verbatim}{
  fontsize=\small, gobble=0, frame=none, numbers=none,
  numbersep=0em, xleftmargin=\sisennys, xrightmargin=0mm,
  baselinestretch=1, samepage=true }

\newcommand{\seurausnuoli}{\textcolor[gray]{.5}{⇒}}

\newenvironment{tulos}{%
  \makebox[0em][r]{\seurausnuoli\enspace}%
  \begin{minipage}[t]{\linewidth}
    \linespread{1}\erikoisfontti\small
  }{%
  \end{minipage}
  \par\vspace{1ex}
  \hrulefill
  \par\addvspace{2ex}
}

\newenvironment{tulossis}{%
  \begin{list}{}{
      \setlength{\leftmargin}{\sisennys}
      \erikoisfontti\small
    }\item[\seurausnuoli]}{%
  \end{list}}

\floatsetup{ font={small}, justification=raggedright,
  margins=raggedright, captionskip=2ex, capposition=bottom }

\captionsetup{ font={small, sf}, labelfont={bf}, textfont={},
  textformat=period, margin=.5em, justification=RaggedRight,
  singlelinecheck=off }

\captionsetup[esimerkki]{ skip=-0.5ex, margin=.5em }

\newcommand{\leijutlk}[2]{%
  \begin{table*}
    \floatbox{table}{\versaalinum #1}{#2}
  \end{table*}}

\newcommand{\leijukuva}[2]{%
  \begin{figure*}
    \floatbox{figure}{#1}{#2}
  \end{figure*}}

\newenvironment{nluetelma}{%
  \begin{list}{\arabic{enumi}.}{
      \usecounter{enumi}
      \setlength{\leftmargin}{1.3em}
      \setlength{\labelsep}{.3em}
      \setlength{\itemsep}{.2ex plus .2ex}
      \setlength{\parsep}{0em}
      \setlength{\topsep}{.2ex plus .2ex}
      \RaggedRight
    }}{\end{list}}

\newenvironment{maaritelma}[1]{%
  \begin{list}{}{
    \setlength{\leftmargin}{\parindent}
    \setlength{\labelwidth}{\parindent}
    \setlength{\listparindent}{\parindent}
    \setlength{\labelsep}{1em}
    \setlength{\itemindent}{1em}
    \setlength{\itemsep}{.2ex plus .2ex}
    \setlength{\parsep}{0em}
    \setlength{\topsep}{.2ex plus .2ex}
    \renewcommand{\makelabel}[1]{#1}
  }}{\end{list}}

\definecolor{tavu}{rgb}{1,0,0}
\definecolor{apuviiva}{gray}{.4}
\definecolor{mittanuoli}{rgb}{1,0,0}

\definecolor{luokka}{rgb}{0,.3,.3}
\definecolor{komento}{rgb}{0,0,.5}
\definecolor{ymparisto}{rgb}{0,.3,0}
\definecolor{mitta}{rgb}{.35,0,0}
\definecolor{laskuri}{rgb}{.4,0,.4}
\definecolor{paketti}{rgb}{.35,.35,0}

\newcommand{\keno}{\textbackslash}
\newcommand{\marginaali}[1]{\marginpar{\RaggedRight\footnotesize #1}}

\newcommand{\koodi}[1]{\texttt{#1}}
\newcommand{\koodimargin}[1]{\marginaali{\koodi{#1}}}
\newcommand{\koodim}[1]{\koodi{#1}\koodimargin{#1}}

\newcommand{\luokkax}[1]{\textcolor{luokka}{\textsf{#1}}}
\newcommand{\luokkai}[1]{\index[luokat]{\luokkax{#1}}}
\newcommand{\luokka}[1]{\luokkax{#1}\luokkai{#1}}
\newcommand{\luokkamargin}[1]{\marginaali{\luokkax{#1}}}
\newcommand{\luokkam}[1]{\luokka{#1}\luokkamargin{#1}}

\newcommand{\komentox}[2][]{\textcolor{komento}{\koodi{\keno #2}\koodi{#1}}}
\newcommand{\komentoi}[1]{\index[komennot]{\komentox{#1}}}
\newcommand{\komento}[2][]{\komentox[#1]{#2}\komentoi{#2}}
\newcommand{\komentomargin}[1]{\marginaali{\komentox{#1}}}
\newcommand{\komentom}[2][]{\komento[#1]{#2}\komentomargin{#2}}

\newcommand{\ymparistox}[1]{\textcolor{ymparisto}{\koodi{#1}}}
\newcommand{\ymparistoi}[1]{\index[ymparistot]{\ymparistox{#1}}}
\newcommand{\ymparisto}[1]{\ymparistox{#1}\ymparistoi{#1}}
\newcommand{\ymparistomargin}[1]{\marginaali{\ymparistox{#1}}}
\newcommand{\ymparistom}[1]{\ymparisto{#1}\ymparistomargin{#1}}

\newcommand{\mittax}[1]{\textcolor{mitta}{\koodi{\keno #1}}}
\newcommand{\mittai}[1]{\index[mitat]{\mittax{#1}}}
\newcommand{\mitta}[1]{\mittax{#1}\mittai{#1}}
\newcommand{\mittamargin}[1]{\marginaali{\mittax{#1}}}
\newcommand{\mittam}[1]{\mitta{#1}\mittamargin{#1}}

\newcommand{\laskurix}[1]{\textcolor{laskuri}{\koodi{#1}}}
\newcommand{\laskurii}[1]{\index[laskurit]{\laskurix{#1}}}
\newcommand{\laskuri}[1]{\laskurix{#1}\laskurii{#1}}
\newcommand{\laskurimargin}[1]{\marginaali{\laskurix{#1}}}
\newcommand{\laskurim}[1]{\laskuri{#1}\laskurimargin{#1}}

\newcommand{\pakettix}[1]{\textcolor{paketti}{\textsf{#1}}}
\newcommand{\pakettii}[1]{\index[paketit]{\pakettix{#1}}}
\newcommand{\paketti}[1]{\pakettix{#1}\pakettii{#1}}
\newcommand{\pakettimargin}[1]{\marginaali{\pakettix{#1}}}
\newcommand{\pakettim}[1]{\paketti{#1}\pakettimargin{#1}}

\newcommand{\tavukohta}{\textcolor{tavu}{\raisebox{-.2ex}{\rule{.6bp}{2ex}}}}
\newcommand{\uctunnus}[1]{\textsc{\englanti{#1}}}
\newcommand{\avctan}[1]{\footnote{\url{https://www.ctan.org/pkg/#1}}}

\newcommand{\ots}[1]{{\sffamily\bfseries #1}}
\newcommand{\otsrivi}[1]{{\sffamily #1}}
\newcommand{\katk}{\discretionary{}{}{}}

% Oppaan tekstissä mainitaan typografinen käytäntö, että
% koodiesimerkkien jälkeen ei sisennetä.
\NoIndentAfterEnv{koodilohkosis}
\NoIndentAfterEnv{tulossis}
\NoIndentAfterEnv{nluetelma}
\NoIndentAfterEnv{maaritelma}

\addto{\captionsfinnish}{
  \renewcommand{\contentsname}{Sisällys}
}

\counterwithout{footnote}{chapter}

\newcommand{\otsikkotyyli}{ \raggedright \sffamily \bfseries }

\titleformat{\chapter}[display]{\Large\bfseries}
{\chaptertitlename\hspace{.3em}\thechapter}{1.5ex}{\otsikkotyyli\huge}[]
\titlespacing*{\chapter}{0em}{*13}{*8}

\titleformat{\section}{\otsikkotyyli\large}
{\thesection}{.8em}{}[]
\titlespacing*{\section}{0pt}{*4}{*2}

\titleformat{\subsection}{\otsikkotyyli\normalsize}
{\thesubsection}{.8em}{}[]
\titlespacing*{\subsection}{0bp}{*2}{*1}

\titleformat{\subsubsection}{\otsikkotyyli\mdseries\itshape\normalsize}
{\thesubsubsection}{.8em}{}[]
\titlespacing*{\subsubsection}{0bp}{*2}{*1}

\titlecontents{chapter}[0em]
{\addvspace{1.5ex}\rmfamily\bfseries\large}
{\makebox[8mm][l]{\thecontentslabel}}
{}
{\small\titlerule[0bp]\contentspage}
[\addvspace{.5ex}]

\titlecontents{section}[0em]
{\addvspace{.5ex}\rmfamily\normalsize}
{\makebox[8mm][l]{\thecontentslabel}}
{}
{~\small\titlerule*[3mm]{.}\contentspage}
[\addvspace{.2ex}]

\titlecontents{subsection}[8mm]
{\rmfamily\small}
{\makebox[10mm][l]{\thecontentslabel}}
{}
{~\small\titlerule*[3mm]{.}\contentspage}
[]

\regtotcounter{chapter}

\begin{document}

\input{tavutusvihjeet}

\pagestyle{empty}

\newgeometry{top=1cm, bottom=1.8cm, hmargin=1.3cm}

% \newgeometry{ top=1cm, bottom=1.8cm, hmargin=1.3cm, papersize={158mm,
%     220mm}, layout=a5paper, layoutoffset={5mm, 5mm}, showcrop }

\pdfbookmark[0]{Nimiö}{luku:nimiö}
\DTMsetstyle{finnish-numeric}

\vspace*{.2\textheight}

{

  \setlength{\parindent}{0pt}

  \fontsize{16bp}{16bp}\rmfamily Teemu Likonen

  \fontsize{52bp}{52bp}\sffamily\bfseries%
  \hspace{-3bp}%
  {\addfontfeatures{LetterSpace=-4} Käytännöllistä}

  \fontsize{65bp}{65bp}\selectfont%
  \hspace{-5bp}%
  \LaTeX{}ia

}

\vfill

{

  \raggedleft
  Latex-ladontajärjestelmän opas \\
  Versio \versio

}

\clearpage
\restoregeometry
\pdfbookmark[0]{Tekijänoikeus}{luku:tekijänoikeus}

\null\vfill

{
  \setlength{\parindent}{0em}
  \setlength{\parskip}{1.2ex plus .1ex}

  \section*{Käytännöllistä Latexia}

  \textsc{Tekijä:} Teemu Likonen \kulmasp{tlikonen@iki.fi}

  \textsc{Versio:} \versio

  \textsc{Päiväys:} \DTMtoday{} kello \DTMcurrenttime{} (Ensijulkaisu:
  ei ole julkaistu vielä)

  % \textsc{Saatavuus:} \url{...}

  \textsc{Lisenssi:} \emph{Creative Commons Nimeä-Jaa\-Samoin 4.0
    Kansainvälinen} (\textsc{cc by-sa} 4.0). Lisenssi antaa sinulle
  luvan kopioida ja levittää tätä teosta tai sen osia missä tahansa
  välineessä ja muodossa. Sisältöä saa muokata, ja sen pohjalta saa
  luoda uusia teoksia mihin tahansa tarkoitukseen, myös kaupallisesti.
  Ehdot ovat seuraavat:

  \begin{list}{\textbullet}{
      \setlength{\leftmargin}{1em}
      \setlength{\topsep}{0ex}
      \setlength{\partopsep}{0ex}
      \setlength{\itemsep}{0ex}
    }
  \item Sinun on mainittava tekijä(t) asianmukaisesti, tarjottava linkki
    lisenssin koko tekstiin (ks. alla) sekä mainittava, mikäli olet
    tehnyt muutoksia.
  \item Jos muokkaat teosta tai luot sen pohjalta uuden teoksen, sinun on
    jaettava muutoksiasi samalla lisenssillä kuin alkuperäistä teosta.
  \item Et saa asettaa sellaisia oikeudellisia ehtoja tai teknisiä
    estoja, jotka estävät muita tekemästä asioita, jotka tämä lisenssi
    sallii.
  \end{list}

  Lisenssin koko teksti: \\
  \url{https://creativecommons.org/licenses/by-sa/4.0/legalcode.fi}

  Poikkeus lisenssiin: Jos teet tästä teoksesta oman sähköisen
  dokumentin (esim. \textsc{pdf}), dokumenttiin mahdollisesti
  upotettavat fontit eivät kuulu tämän lisenssin piiriin, eli niillä saa
  olla jokin toinen lisenssi. Ilmaise sähköisen dokumentin käyttäjille
  selvästi, jos upotettujen fonttien lisenssi rajoittaa käyttöä eri
  tavalla kuin tämä lisenssi ja että tämä lisenssi on silti voimassa
  teoksen muun sisällön osalta. (Jos haluat, voit poistaa tämän
  poikkeuksen, jolloin myös fonttien lisenssin on oltava yhteensopiva
  tämän lisenssin kanssa.)

}

\cleardoublepage

\pagestyle{plain}
\pdfbookmark[0]{Sisällys}{luku:sisallys}
\setcounter{tocdepth}{2}
\tableofcontents

\setcounter{secnumdepth}{-1}
\input{esipuhe}
\setcounter{secnumdepth}{2}
\input{valmistautuminen}
\input{merkintakieli}
\input{asetukset}
\input{rakenne}
\input{matematiikka}
\input{muuta}
\setcounter{secnumdepth}{-1}

\chapter{Kirjallisuutta}
\label{luku:kirjallisuutta}

\printbibliography[heading=none]

\chapter{Asiahakemisto}
\label{luku:asiahakemisto}

\printindex[luokat]
\newpage
\printindex[komennot]
\newpage
\printindex[laskurit]
\newpage
\printindex[mitat]
\newpage
\printindex[paketit]
\newpage
\printindex[ymparistot]

\end{document}
