\documentclass[notitlepage,oneside]{book}
\usepackage[a4paper, vscale=.75, hscale=.68, footskip=1.5cm]{geometry}
\usepackage{fontspec}
%\usepackage{xltxtra}
\usepackage{polyglossia}
%\usepackage{datetime2}
\usepackage{ragged2e}
\usepackage[hang,bottom]{footmisc}
%\usepackage{titling}
\usepackage{titlesec}
%\usepackage{titletoc}
%\usepackage{graphicx}
\usepackage{color}
\usepackage{floatrow}
\usepackage{caption}
\usepackage{newfloat}
\usepackage{fancyvrb}
%\usepackage{placeins}
\usepackage{booktabs}
%\usepackage{fancyhdr}
\usepackage{noindentafter}
\usepackage[unicode,hyperfootnotes=false]{hyperref}
\usepackage[shortcuts]{extdash}

\urlstyle{same}
\hypersetup{ hidelinks, bookmarksopen, bookmarksnumbered,
  pdfauthor={Teemu Likonen} }

\setdefaultlanguage{finnish}
\setotherlanguage{english}

\setmainfont{Linux Libertine O}
[Scale=1.4, Numbers=Lowercase]

\setsansfont{Linux Biolinum O}
[Scale=MatchLowercase, Numbers=Lowercase]

\setmonofont{Linux Libertine Mono O}
[Scale=MatchLowercase, LetterSpace=-2]

\linespread{1.58}

\newcommand{\gemenanum}{\addfontfeatures{Numbers=Lowercase}}
\newcommand{\versaalinum}{\addfontfeatures{Numbers=Uppercase}}

\clubpenalty=10000
\widowpenalty=10000
\setlength{\emergencystretch}{1em}

\setlength{\parindent}{1em}
\setlength{\parskip}{0em}
\setlength{\footnotemargin}{.8em}
\setlength{\floatsep}{3ex}
\setlength{\textfloatsep}{4ex}

\DeclareFloatingEnvironment[ name={Esimerkki} ]{esimerkki}

\DefineVerbatimEnvironment{koodilohko}{Verbatim}{
  fontsize=\footnotesize, gobble=1, frame=lines, numbers=left,
  numbersep=.3em, xleftmargin=0em, xrightmargin=0em, baselinestretch=1.3 }

\DefineVerbatimEnvironment{koodilohkosis}{Verbatim}{
  fontsize=\footnotesize, gobble=2, frame=none, numbers=none,
  numbersep=0em, xleftmargin=\parindent, xrightmargin=0em,
  baselinestretch=1.3, samepage=true }

\floatsetup{ font={small}, justification=raggedright,
  margins=raggedright, captionskip=2ex, capposition=bottom }

\DeclareCaptionFont{rivivali}{\linespread{1.3}\selectfont}

\captionsetup{ font={small, sf, rivivali}, labelfont={bf}, textfont={},
  textformat=period, margin=.5em, justification=raggedright,
  singlelinecheck=off }

\captionsetup[esimerkki]{ skip=-0.5ex, margin=.5em }

\newcommand{\leiju}[3]{
  \begin{#1}
    \floatbox{#1}{#2}{#3}
  \end{#1}
}

\newcommand{\leijutlk}[2]{\leiju{table}{\versaalinum #1}{#2}}
\newcommand{\leijukuva}[2]{\leiju{figure}{#1}{#2}}

%\fancyhf{}
% \fancyhf[hl]{\small\nouppercase{\leftmark}}
% \fancyhf[hr]{\small\nouppercase{\rightmark}}
% \fancyhf[fc]{\thepage}
%\renewcommand{\headrulewidth}{1pt}

% \fancypagestyle{plain}{%
%   \fancyhf{}
%   \fancyhf[fc]{\thepage}
%   \renewcommand{\headrulewidth}{0pt}
% }

\definecolor{tavu}{rgb}{1,0,0}
\definecolor{sitova}{rgb}{1,0,0}

\newcommand{\keno}{\textbackslash}
\newcommand{\koodi}[1]{\texttt{\versaalinum #1}}
\newcommand{\tavuvihje}{\keno-}
\newcommand{\tavukohta}{\textcolor{tavu}{\rule{1pt}{1.5ex}}}
\newcommand{\sitovaym}{\textcolor{sitova}{-}}

\newcommand{\ots}[1]{{\sffamily\bfseries\versaalinum #1}}

\NoIndentAfterEnv{koodilohkosis}

\addto{\captionsfinnish}{
  \renewcommand{\contentsname}{Sisällys}
}

\setcounter{tocdepth}{3}
\setcounter{secnumdepth}{3}

\newcommand{\otsikkotyyli}{ \raggedright \linespread{1.1} \sffamily
  \bfseries }

\titleformat{\chapter}[display]{\LARGE\bfseries}
{\chaptertitlename\hspace{.3em}\thechapter}{1.5ex}{\otsikkotyyli\Huge}[]
\titlespacing*{\chapter}{0em}{*13}{*8}

\titleformat{\section}{\otsikkotyyli\Large}
{\thesection}{.8em}{}[]
\titlespacing*{\section}{0pt}{*4}{*2}

\titleformat{\subsection}{\otsikkotyyli\normalsize}
{\thesubsection}{.8em}{}[]
\titlespacing*{\subsection}{0pt}{*3}{*1}

% \titleformat{\subsubsection}{\otsikkotyyli\normalsize\itshape}
% {\thesubsubsection}{.8em}{}[]
% \titlespacing*{\subsubsection}{0pt}{*3}{*1}

\begin{document}
\pagestyle{empty}

\hyphenation{
  an-tiik-va
  base-line-skip
  docu-ment
  Ext-dash
  font-size
  Font-spec
  foot-note-size
  gro-tes-ki
  huge
  la-don-ta-oh-jel-man
  La-tex-mk
  La-tex-mk-rc
  large
  line-spread
  Lua-la-tex
  Match-Lower-case
  mono-space
  new-font-face
  new-font-family
  ni-men-omaan
  normal-size
  Poly-glos-sia
  Scale
  script-size
  select-font
  set-main-font
  set-mono-font
  set-sans-font
  sf-family
  sf-family-abs
  small
  teks-ti-edi-to-ria
  teks-ti-edi-to-ril-la
  teks-ti-edi-to-rin
  teks-ti-edi-to-ris-sa
  teks-ti-edi-to-ris-ta
  text-ascii-tilde
  text-back-slash
  tiny
  tt-family
  tt-family-abs
  type-writer
  väli-ai-kais-tie-dos-to-jen
  väli-ai-kais-tie-dos-toa
  väli-ai-kais-tie-dos-toon
  väli-ai-kais-tie-dos-tot
  Xe-la-tex
}

%\clearpage
%\pdfbookmark[1]{Sisällys}{luku:sisallys}

% {
%   \renewcommand{\thispagestyle}[1]{}
%   \tableofcontents
% }

\clearpage
\pagestyle{plain}

\chapter*{Esipuhe}
\addcontentsline{toc}{chapter}{Esipuhe}
\phantomsection

% Miksi Latex?

... Niinpä tekstidokumenttien toteuttaminen Latexilla ei ole läheskään
samanlaista kuin työskentely tietotekniikassa yleensä. Yleensähän
käynnistetään jokin sovellus\-ohjelma, joka sisältää suunnilleen kaikki
tarvittavat toiminnot. Samalla sovelluksella työ viedään alusta loppuun.

Sen sijaan Latexin kanssa työskentely on lähempänä ohjelmoijan
työskentelyä. Lähdedokumentti (''koodi'') on muodoltaan täysin erilainen
kuin lopullinen tuotos. Kirjoittaminen vaatii omanlaisensa kielen
osaamista. Lopulliseen toteutukseen tarvitaan yleensä eri tekijöiden
tuottamia makropaketteja (vrt. ohjelmakirjastot), ja niiden ohjekirjojen
lukeminen on osa normaalia työskentelyä. Lähdedokumentit käännetään
erillisellä kääntäjäohjelmalla lopulliseksi tuotokseksi, eikä käännettyä
tuotosta voi enää palauttaa alkuperäiseksi lähdedokumentiksi.

Latexin käyttö ei silti ole mitään ohjelmointia. Merkintäkieli on eri
asia kuin ohjelmointikieli. Työskentelyn luonteessa on kuitenkin useita
yhtäläisyyksiä, ja 

\input{valmistautuminen}
\input{merkintakieli}
\input{asetukset}

\chapter{Dokumentin rakenne}
\section{Kappale}
\label{luku:kappale}

\subsection{Tasaus}
%\sloppy, \fussy
\subsection{Sisennykset ja välit}
\subsection{Riippuva sisennys}
\subsection{Lesket ja orvot}
\section{Korostus}
\section{Otsikot}
\section{Luetelmat}
\section{Taulukot}
\label{luku:taulukot}
\section{Kelluvat osat}
\section{Ristiviitteet}
\section{Alaviitteet}
\section{Tavutus}
\section{Lähdeluettelo ja -viitteet}
\section{Grafiikka}
\section{Laatikot}

\chapter{Matematiikka}
\label{luku:matematiikka}

\chapter{Virittely}
\section{Päiväykset ja kellonajat}

\end{document}
