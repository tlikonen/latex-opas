\documentclass[notitlepage,oneside]{book}
\usepackage[a4paper, vscale=.75, hscale=.68, footskip=1.5cm]{geometry}
\usepackage{fontspec}
% \usepackage[
% input-decimal-markers={,},
% output-decimal-marker={,},
% per-mode=symbol]{siunitx}
%\usepackage{xltxtra}
\usepackage{polyglossia}
\usepackage[finnish,showseconds=false]{datetime2}
\usepackage{ragged2e}
\usepackage[hang,bottom,norule]{footmisc}
%\usepackage{titling}
\usepackage{titlesec}
%\usepackage{titletoc}
%\usepackage{graphicx}
\usepackage{color}
\usepackage{floatrow}
\usepackage{caption}
\usepackage{newfloat}
\usepackage{fancyvrb}
%\usepackage{placeins}
\usepackage{booktabs}
%\usepackage{fancyhdr}
\usepackage{noindentafter}
\usepackage{soul}
\usepackage{imakeidx} \makeindex[intoc]
% \usepackage{ifthen}
\usepackage{chngcntr}
\usepackage{realscripts}
\usepackage[unicode,hyperfootnotes=false]{hyperref}
\usepackage[shortcuts]{extdash}

\urlstyle{same}
\hypersetup{ hidelinks, bookmarksopen, bookmarksnumbered,
  pdfauthor={Teemu Likonen} }

\setdefaultlanguage{finnish}
\setotherlanguage{english}
\newcommand{\englishfont}{}

\defaultfontfeatures[\ttfamily]{Ligatures={TeXReset, NoCommon},
  HyphenChar={-}}
\defaultfontfeatures[\rmfamily,\sffamily]{Ligatures={TeX, Common},
  Numbers=Lowercase}

\setmainfont {Linux Libertine O}
\setsansfont {Linux Biolinum O} [Scale=MatchLowercase]
\setmonofont {Linux Libertine Mono O}
[Scale=MatchLowercase, FakeStretch=.8]

\renewcommand{\footnotesize}{\fontsize{11.34}{14}\selectfont}
\renewcommand{\small}{\fontsize{12.6}{15}\selectfont}
\renewcommand{\normalsize}{\fontsize{14}{18}\selectfont}
\renewcommand{\large}{\fontsize{16.8}{21.6}\selectfont}
\renewcommand{\Large}{\fontsize{20.16}{22}\selectfont}
\renewcommand{\LARGE}{\fontsize{24.192}{26}\selectfont}
\renewcommand{\huge}{\fontsize{29}{32}\selectfont}
\renewcommand{\Huge}{\fontsize{34}{36}\selectfont}
\linespread{1}
\normalsize

\newcommand{\gemenanum}{\addfontfeatures{Numbers=Lowercase}}
\newcommand{\versaalinum}{\addfontfeatures{Numbers=Uppercase}}
\newcommand{\murtoluku}[1]{{\addfontfeatures{Fractions=On}#1}}

\clubpenalty=10000
\widowpenalty=10000
\setlength{\emergencystretch}{1em}

\setlength{\parindent}{1em}
\newlength{\sisennys}\setlength{\sisennys}{1cm}
\setlength{\parskip}{0em}
\setlength{\footnotemargin}{.8em}
\setlength{\skip\footins}{20pt}
\setlength{\floatsep}{.8cm}
\setlength{\textfloatsep}{1cm}

\DeclareFloatingEnvironment[ name={Esimerkki} ]{esimerkki}

\renewcommand{\theFancyVerbLine}
{\sffamily\versaalinum\fontsize{9pt}{9pt}\selectfont\arabic{FancyVerbLine}}

\DefineVerbatimEnvironment{koodilohko}{Verbatim}{ fontsize=\small,
  gobble=2, frame=single, framesep=6pt, numbers=left, numbersep=.3em,
  xleftmargin=0em, xrightmargin=0mm, baselinestretch=1 }

\DefineVerbatimEnvironment{koodilohkosis}{Verbatim}{
  fontsize=\small, gobble=2, frame=none, numbers=none,
  numbersep=0em, xleftmargin=\sisennys, xrightmargin=0mm,
  baselinestretch=1, samepage=true }

\newenvironment{tulossis}
{\begin{list}{}{
      \setlength{\leftmargin}{\sisennys}
      %\setlength{\parsep}{\parskip}
      %\setlength{\listparindent}{\parindent}
      \small
    }\item[⇒]
  }{
  \end{list}
}

\floatsetup{ font={small}, justification=raggedright,
  margins=raggedright, captionskip=2ex, capposition=bottom }

\captionsetup{ font={small, sf}, labelfont={bf}, textfont={},
  textformat=period, margin=.5em, justification=RaggedRight,
  singlelinecheck=off }

\captionsetup[esimerkki]{ skip=-0.5ex, margin=.5em }

\newcommand{\leiju}[3]{
  \begin{#1}
    \floatbox{#1}{#2}{#3}
  \end{#1}
}

\newcommand{\leijutlk}[2]{\leiju{table}{\versaalinum #1}{#2}}
\newcommand{\leijukuva}[2]{\leiju{figure}{#1}{#2}}

%\fancyhf{}
% \fancyhf[hl]{\small\nouppercase{\leftmark}}
% \fancyhf[hr]{\small\nouppercase{\rightmark}}
% \fancyhf[fc]{\thepage}
%\renewcommand{\headrulewidth}{1pt}

% \fancypagestyle{plain}{%
%   \fancyhf{}
%   \fancyhf[fc]{\thepage}
%   \renewcommand{\headrulewidth}{0pt}
% }

\definecolor{tavu}{rgb}{1,0,0}
\definecolor{sitova}{rgb}{1,0,0}

\newcommand{\keno}{\textbackslash}
\newcommand{\koodi}[1]{\texttt{#1}}
\newcommand{\tavukohta}{\textcolor{tavu}{\rule{1pt}{1.5ex}}}
\newcommand{\sitovaym}{\textcolor{sitova}{-}}
\newcommand{\uctunnus}[1]{\textenglish{\textsc{#1}}}
\newcommand{\paketti}[1]{\textenglish{\texttt{#1}}}

\newcommand{\ots}[1]{{\sffamily\bfseries #1}}
\newcommand{\otsrivi}[1]{{\sffamily #1}}

\NoIndentAfterEnv{koodilohkosis}
\NoIndentAfterEnv{tulossis}

\addto{\captionsfinnish}{
  \renewcommand{\contentsname}{Sisällys}
}

\setcounter{tocdepth}{2}
\setcounter{secnumdepth}{2}

\counterwithout{footnote}{chapter}

\newcommand{\otsikkotyyli}{ \raggedright \sffamily \bfseries }

\titleformat{\chapter}[display]{\LARGE\bfseries}
{\chaptertitlename\hspace{.3em}\thechapter}{1.5ex}{\otsikkotyyli\Huge}[]
\titlespacing*{\chapter}{0em}{*13}{*8}

\titleformat{\section}{\otsikkotyyli\Large}
{\thesection}{.8em}{}[]
\titlespacing*{\section}{0pt}{*4}{*2}

\titleformat{\subsection}{\otsikkotyyli\normalsize}
{\thesubsection}{.8em}{}[]
\titlespacing*{\subsection}{0pt}{*3}{*1}

% \titleformat{\subsubsection}{\normalsize\itshape\bfseries}
% {\thesubsubsection}{.8em}{}[]
% \titlespacing*{\subsubsection}{0pt}{*3}{*1}

\begin{document}
\pagestyle{empty}
\addfontfeatures{Numbers=Lowercase}

\hyphenation{
  abst-ra-hoin-ti
  abst-rak-te-ja
  abst-rak-tio-ta-soil-la
  abst-rak-tio-ta-sol-la
  abst-rak-tio-ta-sol-taan
  abst-rak-tio-ta-son
  add-font-fea-tures
  ala-in-dek-se-jä
  ala-in-dek-seil-le
  ala-in-dek-si-ko-men-not
  ala-in-dek-sien
  ala-in-dek-sin
  ala-in-dek-sit
  an-tiik-va
  an-tiik-vaa
  ba-bel
  ba-bel-short-hands
  base-line-skip
  be-gin
  bf-se-ries
  doc-u-ment
  esit-te-ly-osas-sa
  ext-dash
  font-size
  font-spec
  font-ti-ase-tuk-siin
  font-ti-ase-tuk-sil-le
  font-ti-ase-tus
  font-ti-ase-tus-ta
  foot-note-size
  gro-tes-ki
  hspace
  huge
  hy-phen-ation
  ig-nore-spaces
  it-shape
  konk-reet-ti-ses-ti
  konk-reet-ti-sia
  la-don-ta-oh-jel-man
  La-tex-mk
  La-tex-mk-rc
  large
  Lib-er-ti-nus
  line-spread
  Lua-la-tex
  Match-Low-er-case
  mono-space
  new-com-mand
  new-en-vi-ron-ment
  new-font-face
  new-font-fam-i-ly
  ni-men-omaan
  non-stop-mode
  nor-mal-size
  Open
  poly-glos-sia
  pro-vide-com-mand
  re-new-com-mand
  re-new-en-vi-ron-ment
  ro-man
  sa-man-ai-kai-ses-ti
  sans
  Scale
  Scale-Again
  script-size
  se-lect-font
  serif
  set-main-font
  set-mono-font
  set-sans-font
  sf-fam-i-ly
  sf-fam-i-ly-abs
  short-cuts
  sl-shape
  small
  teks-ti-edi-to-ria
  teks-ti-edi-to-ril-la
  teks-ti-edi-to-rin
  teks-ti-edi-to-ris-sa
  teks-ti-edi-to-ris-sa-kin
  teks-ti-edi-to-ris-ta
  text-ascii-tilde
  text-back-slash
  text-en-glish
  text-quote-dbl
  text-quote-sin-gle
  text-su-per-script
  text-sub-script
  tie-to-kone-oh-jel-ma
  tie-to-kone-oh-jel-mat
  tie-to-kone-oh-jel-mia
  tiny
  True
  tt-fam-i-ly
  tt-fam-i-ly-abs
  ty-po-gra-fi-sen
  ty-po-gra-fi-ses-ti
  ty-po-gra-fi-sia
  ty-po-gra-fian
  ty-po-gra-fias-sa
  Type
  type-writ-er
  Uni-code
  use-pack-age
  vaih-to-eh-don
  vaih-to-eh-to
  vaih-to-eh-to-ja
  vir-he-il-moi-tuk-sen
  vir-he-il-moi-tus
  vir-he-il-moi-tus-ta
  vspace
  väli-ai-kai-ses-ti
  väli-ai-kais-tie-dos-to-jen
  väli-ai-kais-tie-dos-toa
  väli-ai-kais-tie-dos-toon
  väli-ai-kais-tie-dos-tot
  Xe-la-tex
  ylä-in-dek-si
  ylä-in-dek-sit
}

\input{kansi}
\input{tekijanoikeus}

\clearpage
\pdfbookmark[1]{Sisällys}{luku:sisallys}
\DTMsetstyle{finnish}

{
  \renewcommand{\thispagestyle}[1]{}
  \tableofcontents
}

\clearpage
\pagestyle{plain}

\input{esipuhe}
\input{valmistautuminen}
\input{merkintakieli}
\input{asetukset}
\input{kirjoittaminen}

\chapter{Matematiikka}
\label{luku:matematiikka}
\section{Käyttöönotto}
\subsection{Unicode-math}
\subsection{Mathspec}
\subsection{Vanha tapa}
\section{Jotain sisältöäkin tarvitaan}
\section{Ympäristöjä}
% align... (amsmath)

\chapter{Muuta}
\section{Päiväykset ja kellonajat}

\printindex

\end{document}
