\documentclass[a4paper,10pt,notitlepage,oneside]{book}
\usepackage[vscale=.75, hscale=.68, footskip=1.5cm]{geometry}
\usepackage{fontspec}
\usepackage{polyglossia}
\usepackage{ragged2e}
\usepackage{footmisc}
%\usepackage{titling}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{color}
\usepackage{floatrow}
\usepackage{caption}
\usepackage{newfloat}
\usepackage{fancyvrb}
%\usepackage{placeins}
\usepackage{booktabs}
%\usepackage{fancyhdr}
%\usepackage{noindentafter}
\usepackage[unicode,hyperfootnotes=false]{hyperref}
\usepackage[shortcuts]{extdash}

\hypersetup{ hidelinks, bookmarksopen, bookmarksnumbered,
  pdfauthor={Teemu Likonen} }

\setdefaultlanguage{finnish}
\setotherlanguage{english}

\setmainfont{Linux Libertine O}
[Scale=1.4, Numbers=Lowercase]

\setsansfont{Linux Biolinum O}
[Scale=MatchLowercase, Numbers=Lowercase]

\setmonofont{Linux Libertine Mono O}
[Scale=MatchLowercase, LetterSpace=-2]

\linespread{1.58}

% \newcommand{\gemenanum}{\addfontfeatures{Numbers=Lowercase}}
% \newcommand{\versaalinum}{\addfontfeatures{Numbers=Uppercase}}

\clubpenalty=10000
\widowpenalty=10000
\setlength{\emergencystretch}{1em}

\setlength{\parindent}{1.2em}
\setlength{\parskip}{0em}
\setlength{\footnotemargin}{\parindent}
\setlength{\floatsep}{3ex}
\setlength{\textfloatsep}{4ex}

\DeclareFloatingEnvironment[ name={Esimerkki} ]{esim}

\DefineVerbatimEnvironment{koodilohko}{Verbatim}{
  fontsize=\footnotesize, gobble=1, frame=lines, numbers=left,
  numbersep=.3em, xleftmargin=0em, xrightmargin=0em, baselinestretch=1.3 }

\floatsetup{ font={small}, justification=raggedright,
  margins=raggedright, captionskip=1ex, capposition=bottom }

\DeclareCaptionFont{rivivali}{\linespread{1.3}\selectfont}

\captionsetup{ font={small, sf, rivivali}, labelfont={bf}, textfont={},
  textformat=period, margin=.5em, justification=raggedright,
  singlelinecheck=off }

\captionsetup[esim]{ skip=-.5ex, margin=.5em }

\newcommand{\leiju}[3]{
  \begin{#1}
    \floatbox{#1}{#2}{#3}
  \end{#1}
}

%\fancyhf{}
% \fancyhf[hl]{\small\nouppercase{\leftmark}}
% \fancyhf[hr]{\small\nouppercase{\rightmark}}
% \fancyhf[fc]{\thepage}
%\renewcommand{\headrulewidth}{1pt}

% \fancypagestyle{plain}{%
%   \fancyhf{}
%   \fancyhf[fc]{\thepage}
%   \renewcommand{\headrulewidth}{0pt}
% }

\definecolor{tavu}{rgb}{1,0,0}
\definecolor{sitova}{rgb}{1,0,0}

\newcommand{\keno}{\textbackslash}
\newcommand{\koodi}[1]{\textsf{#1}}
\newcommand{\tavuvihje}{\keno-}
\newcommand{\tavukohta}{\textcolor{tavu}{\rule{1pt}{1.5ex}}}
\newcommand{\sitovaym}{\textcolor{sitova}{-}}

\newcommand{\ots}[1]{{\sffamily\bfseries #1}}

\addto{\captionsfinnish}{
  \renewcommand{\contentsname}{Sisällys}
}

\newcommand{\otsikkotyyli}{ \raggedright \linespread{1.1} \sffamily
  \bfseries }

\titleformat{\chapter}[display]{\LARGE\bfseries}
{\chaptertitlename\hspace{.3em}\thechapter}{1.5ex}{\otsikkotyyli\Huge}[]
\titlespacing*{\chapter}{0em}{*13}{*8}

\titleformat{\section}{\otsikkotyyli\Large}
{\thesection}{.8em}{}[]
\titlespacing*{\section}{0pt}{*4}{*2}

\titleformat{\subsection}{\otsikkotyyli\normalsize}
{\thesubsection}{.8em}{}[]
\titlespacing*{\subsection}{0pt}{*3}{*1}

\begin{document}
\pagestyle{empty}

\hyphenation{
  Ext-dash
  Font-spec
  Lua-la-tex
  ni-men-omaan
  Open-type
  Poly-glos-sia
  True-type
  Xe-la-tex
}

{
  \renewcommand{\thispagestyle}[1]{}
  %\tableofcontents
}

\clearpage
\pagestyle{plain}

\chapter*{Esipuhe}
\addcontentsline{toc}{chapter}{Esipuhe}
\phantomsection

Suurin innoittajani tämän kirjan kirjoittamiselle on ollut Latex itse.

% Miksi Latex?

\chapter{Valmistautuminen}

\section{Käsitteet ja nimet}

Se, mitä sanalla Latex yleensä tarkoitetaan, on monimutkainen
kokonaisuus erilaisia pieniä palikoita kuten tietokone\-ohjelmia,
makropaketteja ja asetustiedostoja. Yritän tässä luvussa selventää
joitakin peruskäsitteitä.

Tex on tietokone\-ohjelma (\koodi{tex}), joka osaa lukea tietynmuotoisia
tekstitiedostoja ja latoa niiden perusteella tekstidokumentin, joka on
tarkoitettu ihmisten luettavaksi. Tex on myös tekstin ladontaan
tarkoitettu ohjelmointikieli. Se noudattaa sille annettuja ohjeita ja
latoo kirjaimia ja muuta tavaraa peräkkäin sivulle. Ihmisten
näkökulmasta Tex on hyvin tekninen ja matalatasoinen järjestelmä, eikä
sellaisten kanssa yleensä haluta olla missään tekemisissä. Siirtykäämme
siis eteenpäin.

Latex toimii korkeammalla abstraktiotasolla kuin Tex. Se on kokoelma
Tex\-/ohjelmointikielen makroja, jotka piilottavat monimutkaiset
tekniset yksityiskohdat ja toteuttavat varsin helppokäyttöisen
merkintäkielen, joilla tekstidokumenttien rakenne ja ulko\-asua
kuvataan. Ihmiset siis kirjoittavat yleensä Latex\-/muotoisia
dokumentteja, ja Latex eli makrot puolestaan huolehtivat Texin
käskyttämisestä. Latex on myös tietokone\-ohjelma (\koodi{latex}), jolla
lähdetiedoston voi kääntää julkaistavaksi dokumentiksi.

Ajan myötä mukaan on tullut sekalainen joukko muitakin ohjelmia, joista
kannattaa tässä yhteydessä mainita kaksi: Xelatex ja Lualatex. Ne ovat
erilaisia Latexin toteutuksia ja tietokone\-ohjelmia (\koodi{xelatex,
  lualatex}), joilla lähdedokumentti käännetään. Nyky\-aikana käytetään
näistä yleensä jompaakumpaa, ja esimerkiksi tämän kirjan
Latex\-/lähdetiedosto on käännetty PDF\-/tiedostoksi
\koodi{xelatex}\-/komennolla.

Jotta kaikki olisi mahdollisimman sekavaa, sana Latex toimii myös
yleisenä nimityksenä tälle kaikelle. Se esiintyy ilmaisuissa kuten
''Toteutin dokumentin Latexilla'' tai ''Tämä artikkeli on tehty
Latexilla''. Ilmaukset sitten tarkoittavat suunnilleen seuraavanlaista:
Henkilöllä on asennettuna tietokoneelle Latex\-/jakelu (kuten Tex Live).
Hän on kirjoittanut teksti\-editorilla (kuten GNU Emacsilla)
tekstitiedoston, jossa on dokumentin sisältö ja Latex\-/makroille
tarkoitettuja komentoja. Sitten hän on kääntänyt eli ladotuttanut
tekstitiedostonsa PDF\-/tiedostoksi Latex-la\-don\-ta\-oh\-jel\-man
jollakin toteutuksella (kuten Xelatexilla).

Meille \marginpar{\Large\LaTeX} taitaa riittää vain Latexista puhuminen,
mutta siitäkin on mainittava vielä yksi huomio. Latexin harrastajat
tykkäävät käyttää dokumenttiensa leipätekstissä logoja kuten \TeX{} ja
\LaTeX{}. Usein teksteissä näkyy myös logojen pohjalta mukailtuja
kirjoitus\-asuja TeX ja LaTeX. Mielestäni logojen eikä muodikkaiden
kIRjoiTus\-AsuJen paikka ei ole leipätekstissä, koska ne erottuvat
tekstipalstasta liiaksi ja tekevät siitä rauhattoman näköisen. Tässä
kirjassa viittaan kaikkiin nimiin kielenhuollon normien mukaisesti eli
käytän tavallisia erisnimiä kuten Tex ja Latex. Koodi ja komennot ovat
siinä muodossa kuin ne tietokoneelle annetaan, esimerkiksi
\koodi{xelatex}.

\section{Asentaminen}
\label{luku:asentaminen}

\section{Ensimmäinen dokumentti}

Ehkä olisi parasta päästä vain nopeasti kokeilemaan omia
Latex\-/dokumentteja eikä lukea pitkiä jaaritteluja muinaisten
kreikkalaisten Latex\-/filosofiasta. Tallenna esimerkin
\ref{esim:ensimmainen} sisältö teksti\-editorin avulla tiedostoon
vaikkapa nimellä teksti.tex. Käännä eli lado se PDF\-/tiedostoksi
komennolla \koodi{xelatex teksti.tex}.

Tutkitaan esimerkkiä tarkemmin. Ensimmäisellä rivillä määritellään
dokumenttiluokka \textenglish{\koodi{article}}, joka on tietynlainen
sivupohja tai asetusten kokoelma, jonka perustalle aletaan rakentaa omaa
sivua. Luokka \textenglish{\koodi{article}} on tyypillinen valinta
lyhyehköille teksteille. Lisätietoa dokumenttiluokista on luvussa
\ref{luku:dokumenttiluokat}.

Toisella ja kolmannella rivillä käytetään komentoa \koodi{\keno
  usepackage} ja sen avulla otetaan käyttöön fontti- eli
kirjaintyyppi\-asetuksia hoitava Fontspec\-/paketti ja
kieli\-asetuksista vastaava Polyglossia\-/paketti. Kumpaakin tarvitaan
melkein joka kerta dokumenteissa, ja niihin palataan tarkemmin luvuissa
\ref{luku:kirjaintyypit} ja \ref{luku:kieliasetukset}. Sivun asetuksia
käsitellään luvussa \ref{luku:sivuasetukset}.

Seuraavilla riveillä asetetaan kieleksi suomi ja määritetään
oletusfontti. Latin Modern Roman \=/fontin tilalle voi toki kokeilla
muitakin. Fontin oletuskoko on 10 pistettä, mutta tässä esimerkissä se
venytetään 1,3\-/kertaiseksi eli 13 pisteeseen. Riviväliin liittyvä
kerroin asetetaan rivillä 7.

\begin{esim}
\begin{koodilohko}
  \documentclass[a4paper]{article}
  \usepackage{fontspec}
  \usepackage{polyglossia}

  \setdefaultlanguage{finnish}
  \setmainfont{Latin Modern Roman}[Scale=1.3]
  \linespread{1.4}

  \begin{document}

  Minun Latex-dokumenttini!

  \end{document}
\end{koodilohko}
\caption{Ensimmäinen Latex-dokumentti}
\label{esim:ensimmainen}
\end{esim}

Dokumentin alku\-osaa esimerkin riville 8 saakka kutsutaan johdannoksi
tai esittelyksi (engl. \textenglish{\emph{preamble}}). Tässä osassa
ladataan tarvittavat makropaketit ja määritetään dokumentin asetuksia ja
taustatietoja. Riviltä 9 alkaa varsinainen teksti\-osa eli sivulle
ladottava sisältö. Se osa kirjoitetaan
\textenglish{document}\-/ympäristön sisään eli riveillä 9 ja 13 olevien
ympäristön aloitus\-/{} ja lopetuskomentojen väliin.

Tällaisen merkintäkielen ja rakenteen avulla dokumentit kirjoitetaan.
Osa merkintäkielen komennoista tulee Latexin perus\-osasta ja osa tulee
erikseen ladattavista makropaketeista (Fontspec, Polyglossia jne.).
Komentoja voi luoda itsekin.

\section{Apuohjelmia}

\subsection{Tekstieditori}

\subsection{Texdoc}

Latexin kirjoittajan täytyy silloin tällöin lukea ohjekirjoja. Vaikka
Latexin perus\-osat joskus oppisikin ulkoa, ei voi koskaan muistaa
kaikkien hyödyllisten makropakettien kaikkia ominaisuuksia. Myös uusia
makropaketteja ja ihmisten suosituksia tulee vastaan esimerkiksi
verkkokeskusteluissa.

Tex Live \=/jakelun (ks. luku \ref{luku:asentaminen}) mukana tulee
mainio komentotulkissa toimiva komento \koodi{texdoc}, jolla voi hakea
ja avata omaan järjestelmään asennettuja Latex\-/aiheisia ohjeita. Jos
vaikka haluaa tutustua esimerkissä \ref{esim:ensimmainen} mainittuun
Fontspec\-/pakettiin syvällisemmin, tarvitsee vain komentaa
\koodi{texdoc fontspec}, ja paketin PDF\-/muotoinen ohjekirja avautuu.

\subsection{Latexmk}

Hyödyllinen ohjelma on myös Latexmk, joka helpottaa dokumenttien
kääntämistä. Nimittäin varsin usein Latex\-/dokumentit täytyy kääntää
useita kertoja ennen kuin PDF\-/tiedosto on valmis. Se johtuu siitä,
että dokumentit sisältävät usein ristiviitteitä eli viittauksia
dokumentin toisiin osiin. Latex ei saa viitteitä kohdalleen yhdellä
kääntämisellä, vaan ensin se kirjoittaa viittausten kohteet muistiin
väli\-aikais\-tiedostoon ja seuraavilla kääntökerroilla käyttää
väli\-aikais\-tiedostoa apunaan.

Kääntäjä huomauttaa tietokoneen käyttäjää, kun uusintakäännös on
tarpeen, mutta Latexmk\-/ohjelma käynnistää uusintakäännöksen ihan itse,
aina kun se on tarpeellista.

\begin{esim}
\begin{koodilohko}
  latexmk -xelatex  teksti.tex
  latexmk -lualatex teksti.tex
  latexmk -c teksti.tex
  latexmk -C teksti.tex
\end{koodilohko}
\caption{Latexmk-komentoja}
\label{esim:latexmk}
\end{esim}

Esimerkissä \ref{esim:latexmk} on hyödyllisiä komentoja. Rivin 1 komento
kääntää dokumentin Xelatexilla ja rivin 2 komento puolestaan
Lua\-latexilla. Kolmannella rivillä oleva komento poistaa kääntämisen
aikana luodut väli\-aikaistiedostot (\koodi{log, aux, out} ym.), ja
neljännen rivin komento poistaa kaikki luodut tiedostot eli
väli\-aikais\-tiedostojen lisäksi myös valmiin PDF\-/tiedoston. Näissä
esimerkeissä käsitellään lähdetiedostoa nimeltä \koodi{teksti.tex},
mutta jos lähdetiedostoa ei anna komennolle lainkaan, käännetään kaikki
nykyisessä hakemistossa olevat tex\-/päätteiset tiedostot.

\input{esim-latexmkrc}

Latexmk-ohjelmalle voi tehdä asetustiedoston, johon voi kirjoittaa omaan
käyttöön sopivat asetukset. Asetustiedosto sijoitetaan käyttäjän
kotihakemistoon nimellä \koodi{.latexmkrc}. Esimerkki
\ref{esim:latexmkrc} näytää, mitä se voisi ehkä sisältää.

Rivin 1 asetus määrittää, mitä kääntäjää käytetään oletuksena. Riveillä
2 ja 3 määritellään, millä tavoin Xelatex ja Lualatex suoritetaan. Tässä
esimerkissä oletus\-asetuksiin on lisätty \koodi{non\-stop\-mode}, joka
estää kaiken vuorovaikutteisen toiminnan. Asetus on tarpeen ainakin
silloin, kun kääntäjä käynnistetään toisesta ohjelmasta kuten
teks\-ti\-edi\-to\-ris\-ta eikä vuorovaikutus kääntäjän kanssa ole
mahdollista.

Neljännellä rivillä luetellaan kääntämisen aikana syntyvien
väli\-aikais\-tiedostojen päätteitä. Yleiset väli\-aikais\-tiedostot
(\koodi{log, aux, out} ym.) on \koodi{latexmk}\-/ohjelmalla jo tiedossa,
mutta rivin 4 asetuksella mukaan voi lisätä muitakin.

\chapter{Merkintäkieli}
\section{Erikoismerkit}
\section{Komennot, ympäristöt ja lohkot}
\section{Laatikot}

\chapter{Dokumentin asetukset}
\section{Dokumenttiluokat}
\label{luku:dokumenttiluokat}
\section{Kirjaintyypit}
\label{luku:kirjaintyypit}
\section{Kieli}
\label{luku:kieliasetukset}
\section{Sivu}
\label{luku:sivuasetukset}
\subsection{Marginaalit ja mitat}
\subsection{Ylä- ja alatunnisteet}

\chapter{Kirjoittaminen}
\section{Kappale}
\subsection{Tasaus}
\subsection{Sisennykset ja välit}
\subsection{Riippuva sisennys}
\section{Korostus}
\section{Otsikot}
\section{Alaviitteet}
\section{Ristiviitteet}
\section{Tavutus}
\section{Luetelmat}
\section{Taulukot}
\section{Kelluvat osat}
\section{Lähdeluettelo ja -viitteet}
\section{Grafiikka}

\chapter{Matematiikka}

\chapter{Virittely}
\section{Laskurit}
\section{Päiväykset ja kellonajat}

\end{document}
